<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchInput = document.getElementById("search-input");
  const searchButton = document.getElementById("search-button");

  // Capa original con los atributos de usos, vereda y matrícula
  const usosLayer = typeof layer_Predios_Usos_Unidos_0 !== 'undefined' ? layer_Predios_Usos_Unidos_0 : null;

  // Nueva capa GeoJSON con los polígonos base
  let prediosBricenoLayer = null;

  // Capa para resaltar el predio encontrado
  const highlightLayer = new ol.layer.Vector({
    source: new ol.source.Vector(),
    style: new ol.style.Style({
      stroke: new ol.style.Stroke({ color: 'red', width: 3 }),
      fill: new ol.style.Fill({ color: 'rgba(255,0,0,0.1)' })
    })
  });
  map.addLayer(highlightLayer);

  // Cargar la nueva capa GeoJSON
  fetch('Predios_Briceno.geojson')
    .then(response => response.json())
    .then(data => {
      const features = new ol.format.GeoJSON().readFeatures(data, {
        featureProjection: map.getView().getProjection()
      });

      const source = new ol.source.Vector({ features });
      prediosBricenoLayer = new ol.layer.Vector({
        source,
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: 'rgba(0,150,0,0.6)', width: 1 }),
          fill: new ol.style.Fill({ color: 'rgba(0,150,0,0.05)' })
        })
      });
      map.addLayer(prediosBricenoLayer);
    })
    .catch(err => console.error("Error cargando Predios_Briceno.geojson:", err));

  // Función principal del buscador
  function buscarPredio() {
    const texto = searchInput.value.trim();
    if (!texto || !prediosBricenoLayer || !usosLayer) return;

    const prediosSource = prediosBricenoLayer.getSource();
    const usosSource = usosLayer.getSource();

    // Esperar si todavía no han cargado
    if (prediosSource.getFeatures().length === 0 || usosSource.getFeatures().length === 0) {
      setTimeout(buscarPredio, 500);
      return;
    }

    highlightLayer.getSource().clear();
    let found = false;

    const predio = prediosSource.getFeatures().find(f => f.get("PK_PREDIOS")?.toString() === texto);
    const usoData = usosSource.getFeatures().find(f => f.get("PK_PREDIOS")?.toString() === texto);

    if (predio) {
      const geometry = predio.getGeometry();
      const extent = geometry.getExtent();
      map.getView().fit(extent, { duration: 1000, maxZoom: 17 });

      const highlightFeature = predio.clone();
      highlightLayer.getSource().addFeature(highlightFeature);

      // Mostrar popup
      let popupContent = `<b>PK_PREDIOS:</b> ${texto}<br>`;
      if (usoData) {
        popupContent += `<b>Vereda:</b> ${usoData.get("NOMBRE_VER") || "Sin dato"}<br>`;
        popupContent += `<b>Uso del Suelo:</b> ${usoData.get("Usos") || "Sin dato"}`;
      } else {
        popupContent += `<b>Información de usos:</b> No encontrada.`;
      }

      document.getElementById("popup-content").innerHTML = popupContent;
      const coordinates = geometry.getInteriorPoint().getCoordinates();
      popup.setPosition(coordinates);
      found = true;
    }

    if (!found) alert("No se encontró ningún predio con ese PK_PREDIOS.");
  }

  function esperarCapaYBuscar() {
    if (prediosBricenoLayer && prediosBricenoLayer.getSource().getFeatures().length > 0) {
      buscarPredio();
    } else {
      setTimeout(esperarCapaYBuscar, 500);
    }
  }

  searchButton.addEventListener("click", esperarCapaYBuscar);
  searchInput.addEventListener("keypress", function(e) {
    if (e.key === "Enter") esperarCapaYBuscar();
  });

  // Crear overlay del popup
  const container = document.getElementById('popup');
  const content = document.getElementById('popup-content');
  const closer = document.getElementById('popup-closer');

  const popup = new ol.Overlay({
    element: container,
    autoPan: true,
    autoPanAnimation: { duration: 250 }
  });
  map.addOverlay(popup);

  closer.onclick = function () {
    popup.setPosition(undefined);
    closer.blur();
    return false;
  };
});
</script>
