<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Visor de Predios - Briceño</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet base -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- QGIS2Web styles -->
  <link rel="stylesheet" href="styles/qgis2web.css">
  <link rel="stylesheet" href="styles/leaflet.css">

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* Contenedor del buscador */
    .search-container {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 8px 14px;
      border-radius: 12px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #search-input {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 260px;
    }

    #search-button {
      background-color: #33691E;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
    }

    #search-button:hover {
      background-color: #558B2F;
    }

    h1.titulo {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      color: #2E7D32;
      font-size: 22px;
      background: rgba(255, 255, 255, 0.8);
      padding: 6px 14px;
      border-radius: 10px;
      z-index: 900;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="search-container">
    <input id="search-input" type="text" placeholder="Ingrese la matrícula (PK_PREDIOS)">
    <button id="search-button">Buscar</button>
  </div>

  <h1 class="titulo">Visor Catastral - Briceño Antioquia</h1>

  <!-- Capa principal -->
  <script src="layers/Predios_Usos_Unidos_0.js"></script>
  <script src="layers/layers.js"></script>

  <script>
    // Inicializar mapa centrado en Briceño
    var map = L.map('map', {
      zoomControl: true,
      minZoom: 10
    }).setView([7.1025, -75.585], 13);

    // Capa base de mapa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Añadir capa principal de QGIS2Web
    var layer_Predios = new (Predios_Usos_Unidos, {
      onEachFeature: function (feature, layer) {
        var popupContent = "<b>PK_PREDIOS:</b> " + feature.properties.PK_PREDIOS +
                           "<br><b>Vereda:</b> " + feature.properties.NOMBRE_VER +
                           "<br><b>Uso:</b> " + feature.properties.Usos;
        layer.bindPopup(popupContent);
      }
    }).addTo(map);

    // Cargar la capa de búsqueda (invisible)
    var searchLayer;
    fetch('Predios_Briceno.geojson')
      .then(response => response.json())
      .then(data => {
        searchLayer = L.geoJson(data, {
          style: { color: '#000000', weight: 2, opacity: 0 } // invisible
        }).addTo(map);
      });

    var highlight;

    // Función de búsqueda
    document.getElementById('search-button').addEventListener('click', function() {
      var codigo = document.getElementById('search-input').value.trim();
      if (!codigo) return alert('Por favor ingrese una matrícula.');

      if (highlight) map.removeLayer(highlight);

      var found = null;
      searchLayer.eachLayer(function(layer) {
        if (layer.feature.properties.PK_PREDIOS == codigo) {
          found = layer;
        }
      });

      if (found) {
        highlight = L.geoJson(found.toGeoJSON(), {
          style: { color: 'red', weight: 3, fillOpacity: 0.1 }
        }).addTo(map);

        map.fitBounds(found.getBounds());

        // Buscar también en capa principal
        var usoFeature = null;
        layer_Predios.eachLayer(function(layer) {
          if (layer.feature.properties.PK_PREDIOS == codigo) usoFeature = layer;
        });

        if (usoFeature) {
          usoFeature.openPopup();
        } else {
          alert('Predio encontrado, pero sin información de uso.');
        }

      } else {
        alert('No se encontró la matrícula ingresada.');
      }
    });
  </script>
</body>
</html>
